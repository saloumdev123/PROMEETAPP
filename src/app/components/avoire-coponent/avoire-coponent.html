<main class="container py-5 bg-light min-vh-100">
    <h1 class="text-center mb-4 text-danger fw-bold display-5">
        üìÑ Gestion des Avoirs Professionnels
    </h1>

    <!-- FORMULAIRE AVOIR -->
    <div class="card shadow-lg mb-5 border-0">
        <div class="card-header bg-danger text-white text-center fs-5 fw-semibold">
            üßæ Nouvel Avoir
        </div>
        <div class="card-body p-4 bg-white">
            <form [formGroup]="avoirForm" (ngSubmit)="saveAvoir()">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">üë§ Client</label>
                        <select formControlName="clientId" class="form-select" (change)="onClientChange($event)">
                            <option value="">-- Choisir un client --</option>
                            <option *ngFor="let c of clients" [value]="c.id">{{ c.nom }}</option>
                        </select>
                    </div>
                    <!-- üü¶ Informations de paiement -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">üí≥ Mode de r√®glement</label>
                        <input type="text" formControlName="paymentMode" class="form-control"
                            placeholder="Ex : Remboursement (Avoir)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">üí± Taux de l‚ÄôEuro</label>
                        <input type="number" step="0.00001" formControlName="tauxEuro" class="form-control"
                            placeholder="6.55957" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">üî¢ Num√©ro d‚Äôavoir</label>
                        <input type="text" formControlName="number" class="form-control" placeholder="AV-2025-001" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">üìÖ Date d‚Äô√©mission</label>
                        <input type="date" formControlName="dateEmission" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">üìÜ √âch√©ance</label>
                        <input type="date" formControlName="dateEcheance" class="form-control" />
                    </div>

                    <div class="col-md-12">
                        <label class="form-label fw-semibold text-secondary">üßæ R√©f√©rence facture li√©e</label>
                        <input type="text" formControlName="referenceFacture" class="form-control"
                            placeholder="INV-2025-001" />
                    </div>

                             <!-- üßæ ARTICLES -->
          <div class="col-12 mt-4">
            <h5 class="text-primary fw-bold border-bottom pb-2">üßæ Articles de la facture</h5>

            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>R√©f√©rence</th>
                  <th>D√©signation</th>
                  <th>Quantit√©</th>
                  <th>P.U. HT (‚Ç¨)</th>
                  <th>Remise (%)</th>
                  <th>TVA (%)</th>
                  <th>Total HT (‚Ç¨)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody formArrayName="items">
                <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
                  <td><input type="text" formControlName="referenceCode" class="form-control"></td>
                  <textarea formControlName="label" class="form-control" rows="6"
                    style="white-space: pre-wrap; word-wrap: break-word;"
                    placeholder="Description d√©taill√©e de l‚Äôarticle (plusieurs lignes possibles)...">
                 </textarea>
                  <td><input type="number" formControlName="quantity" class="form-control" (input)="recalculerMontant()">
                  </td>
                  <td><input type="number" formControlName="unitPrice" class="form-control" (input)="recalculerMontant()">
                  </td>
                  <td><input type="number" formControlName="discountRate" class="form-control" (input)="recalculerMontant()">
                  </td>
                  <td><input type="number" formControlName="tvaRate" class="form-control" (input)="recalculerMontant()"></td>
                  <td class="fw-bold text-end">
                    {{ (item.value.quantity * item.value.unitPrice * (1 - item.value.discountRate / 100)) |
                    number:'1.2-2' }}
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeItem(i)">üóëÔ∏è</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="text-end">
              <button type="button" class="btn btn-outline-primary btn-sm" (click)="addItem()">‚ûï Ajouter un
                article</button>
            </div>
            <div class="mt-4 card shadow-sm p-3 bg-light">
              <div class="d-flex justify-content-end flex-column align-items-end">
                <p><strong>Base HT :</strong> {{ avoirForm.get('baseHt')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Montant TVA :</strong> {{ avoirForm.get('mtTva')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Total TTC :</strong> {{ avoirForm.get('totalTtc')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Net √† payer :</strong> {{ avoirForm.get('netAPayer')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Remise :</strong> {{ avoirForm.get('remise')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>% TVA :</strong> {{ avoirForm.get('pourcentTva')?.value }} %</p>
                <p><strong>Port :</strong> {{ avoirForm.get('port')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Totaux :</strong> {{ avoirForm.get('totaux')?.value | number:'1.2-2' }} ‚Ç¨</p>
              </div>
            </div>

          </div>

                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-danger px-4 py-2 fw-semibold shadow-sm"
                            [disabled]="avoirForm.invalid || loading">üíæ Enregistrer l‚Äôavoir</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des avoirs -->
    <div class="card shadow-sm border-0 mt-5">
        <div class="card-header bg-dark text-white text-center fw-semibold">
            üìÇ Liste des Avoirs √âmis
        </div>
        <div class="card-body bg-white">
            <table class="table table-hover text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Num√©ro</th>
                        <th>Client</th>
                        <th>Date</th>
                        <th>Montant (‚Ç¨)</th>
                        <th>PDF</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let a of avoirs; let i = index">
                        <td>{{ i + 1 }}</td>
                        <td>{{ a.number }}</td>
                        <td>{{ a.clientName }}</td>
                        <td>{{ a.dateEmission | date:'dd/MM/yyyy' }}</td>
                        <td>{{ a.netAPayer }}</td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" (click)="downloadPdf(a.id)">üì•
                                T√©l√©charger</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>