<div class="container">
  <!-- Progression -->
  <div class="progress-container">
    <div class="progress-bar" [style.width]="progressWidth"></div>
  </div>

  <form (ngSubmit)="onSubmit()">
    <!-- √âtape 0 : Serrurerie -->
    <div *ngIf="currentStep === 0" class="content-row">
      <div class="col-left">
        <img
          src="https://avatars.mds.yandex.net/i?id=3a9e6b0e95ea1f5bf262f3a488b2cc42c6f7ab05-8264209-images-thumbs&n=13"
          alt="Serrurerie">
      </div>
      <div class="col-right">
        <h2>√âlectricit√©</h2>
        <p>
          Que ce soit pour l‚Äôinstallation de prises et interrupteurs, la r√©paration d‚Äôun circuit d√©fectueux
          ou la mise en conformit√© de vos installations √©lectriques, trouvez un prestataire adapt√©.
        </p>
        <ul>
          <li><strong>Accompagnement personnalis√©</strong></li>
          <li><strong>Prestataires √©valu√©s</strong></li>
          <li><strong>Devis en moins de 24h</strong></li>
        </ul>
      </div>
    </div>

    <!-- √âtape 1 -->
    <div *ngIf="currentStep === 1" class="mt-4 mb-5">
      <h2>√âtape 1/14 ‚Äì Donnez un titre √† votre projet</h2>
      <p class="text-muted">Exemple : Installation d‚Äôune prise ou d‚Äôun interrupteur</p>
      <div class="mb-3">
        <input id="projectTitle" type="text" class="form-control" [(ngModel)]="projectTitle" name="projectTitle"
          placeholder="Titre du projet" />
      </div>
    </div>

    <!-- √âtape 2 -->
    <div *ngIf="currentStep === 2" class="mt-4">
      <h2>√âtape 2/14 ‚Äì Pr√©cisions sur votre demande</h2>
      <p>Choisissez installer / remplacer / r√©parer...</p>
      <div class="select-options">
        <button type="button" class="select-btn" [class.active]="selectedOption === 'installer'"
          (click)="selectOption('installer')">Installer</button>
        <button type="button" class="select-btn" [class.active]="selectedOption === 'remplacer'"
          (click)="selectOption('remplacer')">Remplacer</button>
        <button type="button" class="select-btn" [class.active]="selectedOption === 'reparer'"
          (click)="selectOption('reparer')">R√©parer</button>
      </div>
    </div>

    <!-- √âtape 3 -->
    <div *ngIf="currentStep === 3" class="mt-4">
      <h2>√âtape 3/14 ‚Äì Adresse</h2>
      <p>Entrez l‚Äôadresse du chantier</p>
      <div class="form-group mt-3">
        <label for="adresse" class="form-label">Adresse email du chantier</label>
        <input type="email" id="adresse" name="adresseEmail" class="form-control styled-input"
          placeholder="exemple@senfibem.com" [(ngModel)]="adresseEmail" required>
      </div>
    </div>

    <!-- √âtape 4 -->
    <div *ngIf="currentStep === 4" class="mt-4">
      <h2>√âtape 4/14 ‚Äì Budget</h2>
      <p>Entrez votre budget estim√©</p>
      <div class="budget-container">
        <select [(ngModel)]="selectedCurrency" name="currency" class="form-select me-2">
          <option value="USD">Dollar am√©ricain (USD)</option>
          <option value="EUR">Euro (EUR)</option>
          <option value="JPY">Yen japonais (JPY)</option>
          <option value="GBP">Livre sterling (GBP)</option>
          <option value="AUD">Dollar australien (AUD)</option>
          <option value="CAD">Dollar canadien (CAD)</option>
          <option value="CHF">Franc suisse (CHF)</option>
          <option value="CNH">Renminbi chinois (CNH)</option>
          <option value="SEK">Couronne su√©doise (SEK)</option>
          <option value="NZD">Dollar n√©o-z√©landais (NZD)</option>
          <option value="XOF">Franc CFA (XOF)</option>
        </select>

        <input type="number" class="budget-input" min="50" step="50" placeholder="Ex : 50" [(ngModel)]="budget"
          name="budget">
      </div>
      <small class="text-muted">
        Exemple : 50 ‚Äì 500 ‚Ç¨ selon le type de prestation
      </small>
    </div>


    <!-- √âtape 5 : Uploading -->
    <div *ngIf="currentStep === 5" class="mt-4">
      <h2>√âtape 5/14 ‚Äì Uploading de documents</h2>
      <p>S√©lectionnez et t√©l√©versez vos documents requis.</p>

      <!-- Upload documents -->
      <div *ngIf="selectedDocuments.length > 0">
        <h3>üìÇ Documents requis pour {{ role | titlecase }}</h3>
        <div *ngFor="let doc of selectedDocuments">
          <label>{{ doc }}</label>
          <input type="file" (change)="onFilesSelected($event, doc)" accept="image/*,.pdf" multiple>
        </div>
      </div>

      <!-- Preview -->
      <div class="preview-images mt-3" *ngIf="uploadedFiles.length > 0">
        <h4>üìë Fichiers s√©lectionn√©s :</h4>
        <div *ngFor="let file of uploadedFiles" class="preview-item">
          <span class="file-name">{{ file.docName }} ‚Üí {{ file.name }}</span>
          <img *ngIf="file.url && file.url.startsWith('data:image')" [src]="file.url" [alt]="file.name">
        </div>
      </div>

      <!-- Infos compl√©mentaires -->
      <div class="mt-4">
        <h3>Informations compl√©mentaires</h3>

        <!-- Si particulier -->
        <div *ngIf="role === 'PARTICULIER'">
          <input type="text" class="form-control mb-2" placeholder="Pr√©nom" [(ngModel)]="firstName" name="firstName">
          <input type="text" class="form-control mb-2" placeholder="Nom" [(ngModel)]="lastName" name="lastName">
          <input type="email" class="form-control mb-2" placeholder="Email" [(ngModel)]="accountEmail"
            name="accountEmail">
          <input type="tel" class="form-control mb-2" placeholder="T√©l√©phone" [(ngModel)]="phone" name="phone" required>
        </div>

        <!-- Si professionnel -->
        <div *ngIf="role === 'PROFESSIONNEL'">
          <input type="text" class="form-control mb-2" placeholder="Nom de l‚Äôentreprise" [(ngModel)]="companyName"
            name="companyName">
          <input type="text" class="form-control mb-2" placeholder="NINEA" [(ngModel)]="ninea" name="ninea">
          <input type="text" class="form-control mb-2" placeholder="Adresse" [(ngModel)]="companyAddress"
            name="companyAddress">
          <input type="tel" class="form-control mb-2" placeholder="T√©l√©phone" [(ngModel)]="phone" name="phone" required>
          <input type="text" class="form-control mb-2" placeholder="Autres informations" [(ngModel)]="companyAddress"
            name="companyAddress">
        </div>

        <button class="btn btn-primary mt-3" type="submit">Valider</button>
      </div>
    </div>


    <!-- √âtape 6 : Maturit√© -->
    <div *ngIf="currentStep === 6" class="mt-4">
      <h2>√âtape 6/14 ‚Äì Maturit√© de votre projet</h2>
      <p>√âvaluez l'avancement de votre projet pour recevoir un accompagnement personnalis√©.</p>
      <div class="maturite-options">
        <button type="button" class="maturite-btn" [class.active]="maturite === 'accompagnement'"
          (click)="selectMaturite('accompagnement')">
          J'ai besoin d'accompagnement
        </button>
        <button type="button" class="maturite-btn" [class.active]="maturite === 'pret'"
          (click)="selectMaturite('pret')">
          Je suis pr√™t √† d√©marrer
        </button>
      </div>
    </div>
    <!-- √âtape 7 : Adresse intervention -->
    <div *ngIf="currentStep === 7" class="mt-4">
      <h2>√âtape 7/12 ‚Äì Votre adresse</h2>
      <p>Nous utilisons votre adresse pour trouver les prestataires les plus proches.</p>
      <div class="form-group mt-3">
        <label for="interventionAdresse" class="form-label">Adresse de l'intervention</label>
        <input type="text" id="interventionAdresse" name="interventionAdresse" class="form-control styled-input"
          placeholder="ex : 3 rue des sapins 75012 Paris" [(ngModel)]="interventionAdresse" required>
        <small class="text-muted">Seul votre code postal sera visible sur votre demande.</small>
      </div>
    </div>

    <!-- √âtape 8 : Date rendez-vous -->
    <div *ngIf="currentStep === 8" class="mt-4">
      <h2>√âtape 8/14 ‚Äì Date de rendez-vous</h2>
      <p>Quand souhaitez-vous que votre demande soit r√©alis√©e ?</p>
      <div class="date-options">
        <button type="button" class="date-btn" [class.active]="dateOption === 'precise'"
          (click)="selectDateOption('precise')">
          √Ä cette date pr√©cise
        </button>
        <button type="button" class="date-btn" [class.active]="dateOption === 'avant'"
          (click)="selectDateOption('avant')">
          Avant cette date
        </button>
      </div>
      <div class="form-group mt-3" *ngIf="dateOption">
        <label for="rendezVousDate" class="form-label">Choisissez une date</label>
        <input type="date" id="rendezVousDate" class="form-control styled-input" [(ngModel)]="selectedDate"
          name="rendezVousDate" required>
      </div>
    </div>

    <!-- √âtape 9 : Budget & annonces -->
    <div *ngIf="currentStep === 9" class="mt-4">
      <h2>√âtape 9/14 ‚Äì Budget & Annonces similaires</h2>
      <input type="number" class="form-control mb-2" placeholder="Ex : 500 ‚Ç¨" [(ngModel)]="budgetTotal"
        name="budgetTotal" min="50" step="50" required>
      <p><strong>Prix moyen des annonces similaires :</strong> {{ prixMoyenAnnonces }} ‚Ç¨</p>
      <div class="similar-cards">
        <div class="card" *ngFor="let annonce of annoncesSimilaires | slice:0:6">
          <div class="card-header">
            <h4>{{ annonce.titre }}</h4>
            <span class="budget">{{ annonce.budget }} ‚Ç¨</span>
          </div>
          <div class="card-body">
            <p><strong>√âl√©ments :</strong> {{ annonce.elements }}</p>
            <p><strong>Cr√©dence :</strong> {{ annonce.credence }}</p>
            <p><strong>√âl√©ments √©vacu√©s :</strong> {{ annonce.evacuations }}</p>
            <p><strong>Avancement :</strong> {{ annonce.avancement }}</p>
            <p><strong>Localisation :</strong> {{ annonce.localisation }}</p>
          </div>
          <div class="card-footer">
            <button class="btn btn-warning btn-info">Plus d‚Äôinfos...</button>
          </div>
        </div>
      </div>
    </div>

    <!-- √âtape 10 : R√©capitulatif -->
    <div *ngIf="currentStep === 10" class="mt-4 recap-container">
      <h2>√âtape 10/14 ‚Äì R√©capitulatif</h2>
      <p>Voici ce que nous montrerons aux prestataires Fibem.</p>

      <div class="recap-card-container">
        <div class="card recap-card">
          <button class="btn btn-sm btn-info detail-btn" (click)="voirDetail(recapItem)">
            Voir le d√©tail
          </button>
          <img [src]="recapItem.image" class="card-img-top" alt="{{recapItem.titre}}">
          <div class="card-body">
            <h5 class="card-title">{{ recapItem.titre }}</h5>
            <p class="card-text">{{ recapItem.description }}</p>
            <p class="budget">
              <strong>{{ recapItem.budget }} {{ recapItem.currency }}</strong>
            </p>

            <!-- ‚úÖ Bouton Ajouter au panier -->
            <button class="btn btn-warning w-100 mt-2" (click)="ajouterAuPanier(recapItem)">
              <i class="bi bi-cart-plus"></i> Ajouter au panier
            </button>
          </div>
        </div>
      </div>
    </div>



    <!-- √âtape 11 : Coordonn√©es utilisateur -->
    <!-- √âtape 11 : Coordonn√©es utilisateur -->
    <div *ngIf="currentStep === 11" class="mt-4">
      <h2>√âtape 11/14 ‚Äì Vos coordonn√©es</h2>

      <!-- Email -->
      <div class="form-group mt-3">
        <label for="userEmail" class="form-label">Votre email</label>
        <input type="email" id="userEmail" name="userEmail" class="form-control styled-input" [(ngModel)]="userEmail"
          placeholder="ex: louis.durand@gmail.com" required>
      </div>

      <!-- T√©l√©phone -->
      <div class="form-group mt-3">
        <label for="phoneNumber" class="form-label">Votre t√©l√©phone</label>
        <div class="input-group">
          <select [(ngModel)]="selectedCountryCode" name="countryCode" class="form-select w-auto"
            (change)="updatePhonePlaceholder()">
            <option *ngFor="let c of countryCodes" [value]="c.code">
              {{ c.label }} ({{ c.code }})
            </option>
          </select>
          <input type="tel" id="phoneNumber" name="phoneNumber" class="form-control styled-input"
            [(ngModel)]="phoneNumber" [placeholder]="phonePlaceholder" (blur)="validatePhoneNumber()" required>
        </div>
        <!-- Message d'erreur -->
        <small *ngIf="phoneError" class="text-danger">
          Le num√©ro doit commencer par {{ selectedCountryCode }}
        </small>
      </div>
    </div>


    <div *ngIf="isStep12()" class="mt-4 account-container">
      <h2>√âtape 12 ‚Äì Cr√©er votre compte {{ role | titlecase }}</h2>

      <!-- Message commission -->
      <div *ngIf="role === 'PARTICULIER'" class="alert alert-info">
        üí° Une commission de <strong>1% √† 3%</strong> sera automatiquement appliqu√©e par la plateforme
        sur le montant pay√©. Vous devez cocher pour accepter.
      </div>
      <div *ngIf="role === 'PROFESSIONNEL'" class="alert alert-info">
        üí° Une commission de <strong>3% √† 15%</strong> sera automatiquement appliqu√©e par la plateforme
        selon la prestation. Vous devez cocher pour accepter.
      </div>

      <!-- Case confirmation commission -->


      <!-- Champ commission -->


      <!-- Formulaires sp√©cifiques -->
      <div *ngIf="role === 'PARTICULIER'" class="personal-info mt-3">
        <input type="text" class="form-control mb-2" placeholder="Pr√©nom" [(ngModel)]="firstName" name="firstName"
          required>
        <input type="text" class="form-control mb-2" placeholder="Nom" [(ngModel)]="lastName" name="lastName" required>
        <input type="email" class="form-control mb-2" placeholder="Email" [(ngModel)]="accountEmail" name="accountEmail"
          required>
        <input type="tel" class="form-control mb-2" placeholder="T√©l√©phone" [(ngModel)]="phone" name="phone" required>
        <input type="password" class="form-control mb-2" placeholder="Mot de passe" [(ngModel)]="password"
          name="password" required>
      </div>

      <div *ngIf="role === 'PROFESSIONNEL'" class="personal-info mt-3">
        <input type="text" class="form-control mb-2" placeholder="Nom de l‚Äôentreprise" [(ngModel)]="companyName"
          name="companyName" required>
        <input type="text" class="form-control mb-2" placeholder="NINEA" [(ngModel)]="ninea" name="ninea" required>
        <input type="email" class="form-control mb-2" placeholder="Email" [(ngModel)]="accountEmail" name="accountEmail"
          required>
        <input type="tel" class="form-control mb-2" placeholder="T√©l√©phone" [(ngModel)]="phone" name="phone" required>
        <input type="password" class="form-control mb-2" placeholder="Mot de passe" [(ngModel)]="password"
          name="password" required>
      </div>

      <div *ngIf="role === 'ADMIN'" class="personal-info mt-3">
        <input type="text" class="form-control mb-2" placeholder="Identifiant admin" [(ngModel)]="firstName"
          name="firstName" required>
        <input type="email" class="form-control mb-2" placeholder="Email" [(ngModel)]="accountEmail" name="accountEmail"
          required>
        <input type="password" class="form-control mb-2" placeholder="Mot de passe" [(ngModel)]="password"
          name="password" required>
      </div>

      <!-- Conditions -->
      <div class="form-check mb-2">
        <input type="checkbox" [(ngModel)]="marketingConsent" name="marketingConsent" class="form-check-input">
        <label class="form-check-label">Je souhaite recevoir des infos marketing.</label>
      </div>
      <div class="form-check">
        <input type="checkbox" [(ngModel)]="acceptTerms" name="acceptTerms" class="form-check-input" required>
        <label class="form-check-label">J‚Äôaccepte les conditions g√©n√©rales.</label>
      </div>
    </div>


    <!-- √âtape 13 : Paiement -->
    <div *ngIf="currentStep === 13" class="mt-4 payment-container">
      <h2>√âtape 13/14 ‚Äì Paiement s√©curis√©</h2>
      <p>Choisissez un mode de paiement :</p>

      <div class="payment-methods">
        <button type="button" class="btn btn-outline-primary me-2" [class.active]="selectedPayment === 'carte'"
          (click)="selectPayment('carte')">
          üí≥ Carte Bancaire
        </button>
        <button type="button" class="btn btn-outline-success me-2" [class.active]="selectedPayment === 'wave'"
          (click)="selectPayment('wave')">
          üåä Wave
        </button>
        <button type="button" class="btn btn-outline-warning" [class.active]="selectedPayment === 'orange'"
          (click)="selectPayment('orange')">
          üü† Orange Money
        </button>
      </div>

      <div class="mt-4">
        <h4>Montant √† payer :</h4>
        <p>
          <strong>{{ budgetTotal }} {{ selectedCurrency }}</strong>
          <span class="text-muted">(inclut {{ commissionRate }}% de commission Fibem)</span>
        </p>
      </div>

      <div *ngIf="selectedPayment === 'carte'" class="mt-3">
        <label>Num√©ro de carte</label>
        <input type="text" class="form-control mb-2" placeholder="XXXX-XXXX-XXXX-XXXX" [(ngModel)]="cardNumber">
        <label>Date d‚Äôexpiration</label>
        <input type="text" class="form-control mb-2" placeholder="MM/AA" [(ngModel)]="cardExpiry">
        <label>CVV</label>
        <input type="text" class="form-control mb-2" placeholder="123" [(ngModel)]="cardCvv">
      </div>

      <button type="button" class="btn btn-success mt-3" (click)="effectuerPaiement()">üí∞ Payer</button>
    </div>
    <!-- √âtape 14 : Confirmation de paiement -->
    <div *ngIf="currentStep === 14" class="mt-4 payment-confirmation">
      <h2>‚úÖ √âtape 14/15 ‚Äì Paiement effectu√© avec succ√®s</h2>
      <p>Merci {{ firstName }} ! Votre transaction a bien √©t√© enregistr√©e.</p>

      <div class="receipt mt-3">
        <h4>D√©tails du paiement :</h4>
        <ul>
          <li><strong>Num√©ro de transaction :</strong> {{ transactionId }}</li>
          <li><strong>Montant :</strong> {{ budgetTotal }} {{ selectedCurrency }}</li>
          <li><strong>M√©thode :</strong> {{ selectedPayment | titlecase }}</li>
          <li><strong>Date :</strong> {{ paymentDate | date:'short' }}</li>
          <li><strong>Signature √©lectronique :</strong> {{ electronicSignature }}</li>
        </ul>
      </div>

      <button class="btn btn-primary mt-3" (click)="telechargerRecu()">‚¨áÔ∏è T√©l√©charger le re√ßu</button>
    </div>

    <!-- Pr√©cision -->
    <div class="recap-precision mt-3">
      <label for="precision" class="form-label">Une pr√©cision √† ajouter ?</label>
      <textarea id="precision" class="form-control" [(ngModel)]="precision" name="precision"
        placeholder="Ex : D√©placer l'√©vier..."></textarea>
    </div>

    <!-- Navigation -->
    <div class="btn-group mt-4">
      <!-- Bouton Pr√©c√©dent -->
      <button type="button" class="btn btn-warning me-2" (click)="prevStep()" [disabled]="currentStep === 0">
        Pr√©c√©dent
      </button>

      <!-- Bouton Suivant / Terminer -->
      <button type="button" class="btn btn-primary" *ngIf="currentStep < 14" (click)="nextStep()"
        [disabled]="!canGoNextStep()">
        {{ currentStep === 0 ? 'D√©marrer' : (isStep12() ? 'S‚Äôinscrire et publier' : 'Suivant') }}
      </button>

      <button type="button" class="btn btn-success" *ngIf="currentStep === 14" (click)="finish()">
        Terminer
      </button>
    </div>

  </form>
</div>