<main class="container py-5 bg-light min-vh-100">
  <h1 class="text-center mb-4 text-primary fw-bold display-5">
    ğŸ§¾ Gestion des Factures Professionnelles
  </h1>

  <!-- ğŸ’¡ FORMULAIRE DE CRÃ‰ATION -->
  <div class="card shadow-lg mb-5 border-0">
    <div class="card-header bg-primary text-white text-center fs-5 fw-semibold">
      ğŸ§© Nouvelle Facture
    </div>
    <div class="card-body p-4 bg-white">
      <form [formGroup]="invoiceForm" (ngSubmit)="saveInvoice()">
        <div class="row g-3">

          <!-- ğŸ§‘â€ğŸ¤â€ğŸ§‘ SÃ©lection client -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">ğŸ‘¥ SÃ©lectionner un client *</label>
            <select formControlName="clientId" class="form-select shadow-sm" (change)="onClientChange($event)">
              <option value="">-- Choisir un client --</option>
              <option *ngFor="let c of clients" [value]="c.id">{{ c.nom }} - {{ c.email }}</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">ğŸ·ï¸ Titre de la facture *</label>
            <input type="text" formControlName="titre" class="form-control shadow-sm"
              placeholder="Ex : Facture de maintenance" />
          </div>

          <!-- ğŸ“‹ Description -->
          <div class="col-12">
            <label class="form-label fw-semibold text-secondary">ğŸ“ Description</label>
            <textarea formControlName="description" rows="2" class="form-control shadow-sm"
              placeholder="DÃ©tails de la prestation..."></textarea>
          </div>

          <!-- ğŸ“… Dates -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">ğŸ“… Date dâ€™Ã©mission</label>
            <input type="date" formControlName="dateEmission" class="form-control shadow-sm" />
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">ğŸ“† Date dâ€™Ã©chÃ©ance</label>
            <input type="date" formControlName="dateEcheance" class="form-control shadow-sm" />
          </div>

          <!-- ğŸ”– RÃ©fÃ©rence / Devis / Paiement -->
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">ğŸ”– RÃ©fÃ©rence</label>
            <input type="text" formControlName="reference" class="form-control shadow-sm" placeholder="REF-2025-001" />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">ğŸ“‘ NumÃ©ro de devis</label>
            <input type="text" formControlName="devisNumber" class="form-control shadow-sm" placeholder="DEV-0012" />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">ğŸ’³ Mode de paiement</label>
            <select formControlName="paymentMode" class="form-select shadow-sm">
              <option value="Virement bancaire">Virement bancaire</option>
              <option value="EspÃ¨ces">EspÃ¨ces</option>
              <option value="ChÃ¨que">ChÃ¨que</option>
              <option value="Carte">Carte bancaire</option>
            </select>
          </div>

          <!-- ğŸ§¾ CLIENT INFOS -->
          <div class="col-12">
            <h5 class="mt-4 text-primary fw-bold border-bottom pb-2">ğŸ‘¤ Informations Client</h5>
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="nomClient" class="form-control shadow-sm" placeholder="Nom du client" />
          </div>
          <div class="col-md-6">
            <input type="email" formControlName="emailClient" class="form-control shadow-sm"
              placeholder="Email du client" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="telephoneClient" class="form-control shadow-sm"
              placeholder="TÃ©lÃ©phone" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="adresseClient" class="form-control shadow-sm"
              placeholder="Adresse complÃ¨te" />
          </div>

          <!-- ğŸ¢ ENTREPRISE -->
          <div class="col-12">
            <h5 class="mt-4 text-primary fw-bold border-bottom pb-2">ğŸ¢ Informations SociÃ©tÃ©</h5>
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyName" class="form-control shadow-sm"
              placeholder="Nom de l'entreprise" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyContact" class="form-control shadow-sm"
              placeholder="Contact entreprise" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyPhone" class="form-control shadow-sm"
              placeholder="TÃ©lÃ©phone sociÃ©tÃ©" />
          </div>
          <div class="col-md-6">
            <input type="email" formControlName="companyEmail" class="form-control shadow-sm"
              placeholder="Email sociÃ©tÃ©" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companySiret" class="form-control shadow-sm" placeholder="SIRET" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyTvaNumber" class="form-control shadow-sm"
              placeholder="NumÃ©ro TVA" />
          </div>
          <div class="col-md-12">
            <input type="text" formControlName="companyAddress" class="form-control shadow-sm"
              placeholder="Adresse complÃ¨te sociÃ©tÃ©" />
          </div>

          <!-- ğŸ§¾ ARTICLES -->
          <div class="col-12 mt-4">
            <h5 class="text-primary fw-bold border-bottom pb-2">ğŸ“¦ Articles de la facture</h5>
          </div>

          <!-- ğŸ·ï¸ En-tÃªtes visuelles -->
          <div class="row fw-semibold text-secondary border-bottom pb-1 mb-2">
            <div class="col-md-2">RÃ©fÃ©rence</div>
            <div class="col-md-3">LibellÃ©</div>
            <div class="col-md-1 text-center">QtÃ©</div>
            <div class="col-md-2 text-center">Prix unitaire</div>
            <div class="col-md-1 text-center">% Rem</div>
            <div class="col-md-2 text-center">Total</div>
            <div class="col-md-1 text-center">Action</div>
          </div>

          <div formArrayName="items">
            <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="row g-3 align-items-center mb-2">
              <!-- ğŸ”– RÃ©fÃ©rence -->
              <div class="col-md-2">
                <input type="text" class="form-control shadow-sm" placeholder="RÃ©f." formControlName="referenceCode" />
              </div>

              <!-- ğŸ·ï¸ LibellÃ© -->
              <div class="col-md-3">
                <input type="text" class="form-control shadow-sm" placeholder="LibellÃ©" formControlName="label" />
              </div>

              <!-- ğŸ”¢ QuantitÃ© -->
              <div class="col-md-1">
                <input type="number" class="form-control shadow-sm" placeholder="QtÃ©" formControlName="quantity" />
              </div>

              <!-- ğŸ’° Prix unitaire -->
              <div class="col-md-2">
                <input type="number" class="form-control shadow-sm" placeholder="PU" formControlName="unitPrice" />
              </div>

              <!-- ğŸ¯ Remise -->
              <div class="col-md-1">
                <input type="number" class="form-control shadow-sm" placeholder="% Rem" formControlName="discountRate" />
              </div>

              <!-- ğŸ“Š Total -->
              <div class="col-md-2">
                <input type="number" class="form-control shadow-sm bg-light" placeholder="Total" formControlName="lineTotal" readonly />
              </div>

              <!-- ğŸ—‘ï¸ Action -->
              <div class="col-md-1 text-center">
                <button class="btn btn-danger btn-sm shadow-sm" type="button" (click)="removeItem(i)">ğŸ—‘ï¸</button>
              </div>
            </div>

            <div class="text-end">
              <button type="button" class="btn btn-outline-primary btn-sm mt-2 shadow-sm" (click)="addItem()">
                â• Ajouter un article
              </button>
            </div>
          </div>

          <!-- ğŸ’° Totaux -->
          <div class="col-md-3 mt-4">
            <label class="form-label fw-semibold text-secondary">ğŸ’° Sous-total (HT)</label>
            <input type="number" formControlName="subTotal" class="form-control shadow-sm" readonly />
          </div>
          <div class="col-md-3 mt-4">
            <label class="form-label fw-semibold text-secondary">ğŸ’¸ TVA (%)</label>
            <input type="number" formControlName="taxRate" class="form-control shadow-sm" />
          </div>
          <div class="col-md-3 mt-4">
            <label class="form-label fw-semibold text-secondary">ğŸ’µ Total TTC</label>
            <input type="number" formControlName="total" class="form-control shadow-sm" readonly />
          </div>
          <div class="col-md-3 mt-4">
            <label class="form-label fw-semibold text-secondary">ğŸ’¼ Montant dÃ»</label>
            <input type="number" formControlName="amountDue" class="form-control shadow-sm" readonly />
          </div>

          <!-- âœ… Enregistrer -->
          <div class="col-12 text-end mt-4">
            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold shadow-sm"
              [disabled]="invoiceForm.invalid || loading">
              ğŸ’¾ Enregistrer la facture
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ğŸ“Š LISTE DES FACTURES -->
  <div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0 text-secondary fw-bold">ğŸ“Š Liste des Factures</h5>
      <select [(ngModel)]="filtreStatut" (change)="filter()" class="form-select w-auto shadow-sm">
        <option value="">-- Filtrer par statut --</option>
        <option value="BROUILLON">Brouillon</option>
        <option value="EN_ATTENTE">En attente</option>
        <option value="PAYÃ‰E">PayÃ©e</option>
        <option value="EN_RETARD">En retard</option>
        <option value="ANNULÃ‰E">AnnulÃ©e</option>
      </select>
    </div>

    <div class="card-body">
      <div class="row g-4">
        <div *ngFor="let f of factures" class="col-md-6 col-lg-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <h5 class="text-primary fw-bold">{{ f.title }}</h5>
              <p class="mb-1"><strong>Montant :</strong> {{ f.total | currency:'XOF' }}</p>
              <p class="mb-1"><strong>Client :</strong> {{ f.clientName }}</p>
              <p class="mb-1"><strong>Date :</strong> {{ f.issueDate }}</p>
              <p>
                <strong>Statut :</strong>
                <span [ngClass]="{
                    'badge bg-warning text-dark': f.status === 'EN_ATTENTE',
                    'badge bg-success': f.status === 'PAYÃ‰E',
                    'badge bg-danger': f.status === 'ANNULÃ‰E',
                    'badge bg-info text-dark': f.status === 'BROUILLON',
                    'badge bg-secondary': f.status === 'EN_RETARD'
                  }">
                  {{ f.status }}
                </span>
              </p>
            </div>
            <div class="card-footer bg-light text-end">
              <button (click)="telechargerFacture(f)" class="btn btn-outline-primary btn-sm shadow-sm">
                â¬‡ï¸ TÃ©lÃ©charger PDF
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
