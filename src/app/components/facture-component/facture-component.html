<main class="container py-5 bg-light min-vh-100">
  <h1 class="text-center mb-4 text-primary fw-bold display-5">
    ğŸ§¾ Gestion des Factures Professionnelles
  </h1>

  <!-- ğŸ’¡ FORMULAIRE DE CRÃ‰ATION -->
  <div class="card shadow-lg mb-5 border-0">
    <div class="card-header bg-primary text-white text-center fs-5 fw-semibold">
      ğŸ§© Nouvelle Facture
    </div>
    <div class="card-body p-4 bg-white">
      <form [formGroup]="invoiceForm" (ngSubmit)="saveInvoice()">
        <div class="row g-3">

          <!-- ğŸ§‘â€ğŸ¤â€ğŸ§‘ SÃ©lection client -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">ğŸ‘¥ SÃ©lectionner un client *</label>
            <select formControlName="clientId" class="form-select shadow-sm" (change)="onClientChange($event)">
              <option value="">-- Choisir un client --</option>
              <option *ngFor="let c of clients" [value]="c.id">{{ c.nom }} - {{ c.email }}</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">ğŸ·ï¸ Titre de la facture *</label>
            <input type="text" formControlName="titre" class="form-control shadow-sm"
              placeholder="Ex : Facture de maintenance" />
          </div>

          <!-- ğŸ“‹ Description -->
          <div class="col-12">
            <label class="form-label fw-semibold text-secondary">ğŸ“ Description</label>
            <textarea formControlName="description" rows="2" class="form-control shadow-sm"
              placeholder="DÃ©tails de la prestation..."></textarea>
          </div>

          <!-- ğŸ“… Dates -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">ğŸ“… Date dâ€™Ã©mission</label>
            <input type="date" formControlName="dateEmission" class="form-control shadow-sm" />
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">ğŸ“† Date dâ€™Ã©chÃ©ance</label>
            <input type="date" formControlName="dateEcheance" class="form-control shadow-sm" />
          </div>

          <!-- ğŸ§¾ NumÃ©ro de facture + acompte -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="number" class="form-label fw-bold text-secondary">ğŸ”¢ NumÃ©ro de facture</label>
              <input type="text" id="number" formControlName="number" class="form-control shadow-sm"
                placeholder="EX: INV-2025-001">
            </div>

            <div class="col-md-6 mb-3">
              <label for="acompte" class="form-label fw-bold text-secondary">ğŸ’¶ Acompte (â‚¬)</label>
              <input type="number" id="acompte" formControlName="acompte" class="form-control shadow-sm"
                placeholder="0.00" step="0.01">
            </div>
          </div>

          <!-- ğŸ”– RÃ©fÃ©rence / Devis / Paiement -->
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">ğŸ”– RÃ©fÃ©rence</label>
            <input type="text" formControlName="reference" class="form-control shadow-sm" placeholder="REF-2025-001" />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">ğŸ“‘ NumÃ©ro de devis</label>
            <input type="text" formControlName="devisNumber" class="form-control shadow-sm" placeholder="DEV-0012" />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">ğŸ’³ Mode de paiement</label>
            <select formControlName="paymentMode" class="form-select shadow-sm">
              <option value="Virement bancaire">Virement bancaire</option>
              <option value="EspÃ¨ces">EspÃ¨ces</option>
              <option value="ChÃ¨que">ChÃ¨que</option>
              <option value="Carte">Carte bancaire</option>
            </select>
          </div>

          <!-- ğŸ‘¤ INFOS CLIENT -->
          <div class="col-12">
            <h5 class="mt-4 text-primary fw-bold border-bottom pb-2">ğŸ‘¤ Informations Client</h5>
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="clientName" class="form-control shadow-sm"
              placeholder="Nom du client" />
          </div>
          <div class="col-md-6">
            <input type="email" formControlName="clientEmail" class="form-control shadow-sm"
              placeholder="Email du client" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="clientPhone" class="form-control shadow-sm" placeholder="TÃ©lÃ©phone" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="clientAddress" class="form-control shadow-sm"
              placeholder="Adresse complÃ¨te" />
          </div>

          <!-- ğŸ¢ ENTREPRISE -->
          <div class="col-12">
            <h5 class="mt-4 text-primary fw-bold border-bottom pb-2">ğŸ¢ Informations SociÃ©tÃ©</h5>
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyName" class="form-control shadow-sm"
              placeholder="Nom de l'entreprise" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyContact" class="form-control shadow-sm"
              placeholder="Contact entreprise" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyPhone" class="form-control shadow-sm"
              placeholder="TÃ©lÃ©phone sociÃ©tÃ©" />
          </div>
          <div class="col-md-6">
            <input type="email" formControlName="companyEmail" class="form-control shadow-sm"
              placeholder="Email sociÃ©tÃ©" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companySiret" class="form-control shadow-sm" placeholder="SIRET" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyTvaNumber" class="form-control shadow-sm"
              placeholder="NumÃ©ro TVA" />
          </div>
          <div class="col-md-12">
            <input type="text" formControlName="companyAddress" class="form-control shadow-sm"
              placeholder="Adresse complÃ¨te sociÃ©tÃ©" />
          </div>

          <!-- ğŸ§¾ ARTICLES -->
          <div class="col-12 mt-4">
            <h5 class="text-primary fw-bold border-bottom pb-2">ğŸ§¾ Articles de la facture</h5>

            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>RÃ©fÃ©rence</th>
                  <th>DÃ©signation</th>
                  <th>QuantitÃ©</th>
                  <th>P.U. HT (â‚¬)</th>
                  <th>Remise (%)</th>
                  <th>TVA (%)</th>
                  <th>Total HT (â‚¬)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody formArrayName="items">
                <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
                  <td><input type="text" formControlName="referenceCode" class="form-control"></td>
                  <textarea formControlName="label" class="form-control" rows="6"
                    style="white-space: pre-wrap; word-wrap: break-word;"
                    placeholder="Description dÃ©taillÃ©e de lâ€™article (plusieurs lignes possibles)...">
                 </textarea>
                  <td><input type="number" formControlName="quantity" class="form-control" (input)="updateTotals()">
                  </td>
                  <td><input type="number" formControlName="unitPrice" class="form-control" (input)="updateTotals()">
                  </td>
                  <td><input type="number" formControlName="discountRate" class="form-control" (input)="updateTotals()">
                  </td>
                  <td><input type="number" formControlName="tvaRate" class="form-control" (input)="updateTotals()"></td>
                  <td class="fw-bold text-end">
                    {{ (item.value.quantity * item.value.unitPrice * (1 - item.value.discountRate / 100)) |
                    number:'1.2-2' }}
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeItem(i)">ğŸ—‘ï¸</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="text-end">
              <button type="button" class="btn btn-outline-primary btn-sm" (click)="addItem()">â• Ajouter un
                article</button>
            </div>
            <div class="mt-4 card shadow-sm p-3 bg-light">
              <div class="d-flex justify-content-end flex-column align-items-end">
                <p><strong>Base HT :</strong> {{ baseHT | number:'1.2-2' }} â‚¬</p>
                <p><strong>Remise :</strong> {{ invoiceForm.get('remise')?.value | number:'1.2-2' }} â‚¬</p>
                <p><strong>Montant TVA :</strong> {{ totalTVA | number:'1.2-2' }} â‚¬</p>
                <p><strong>% TVA :</strong> {{ invoiceForm.get('pourcentTva')?.value }} %</p>
                <p><strong>Port :</strong> {{ invoiceForm.get('port')?.value | number:'1.2-2' }} â‚¬</p>
                <p><strong>Totaux :</strong> {{ invoiceForm.get('totaux')?.value | number:'1.2-2' }} â‚¬</p>
                <p><strong>Total TTC :</strong> {{ totalTTC | number:'1.2-2' }} â‚¬</p>
                <p><strong>Net Ã  payer :</strong> {{ netAPayer | number:'1.2-2' }} â‚¬</p>
              </div>
            </div>

          </div>


          <!-- âœ… Enregistrer -->
          <div class="col-12 text-end mt-4">
            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold shadow-sm"
              [disabled]="invoiceForm.invalid || loading">
              ğŸ’¾ Enregistrer la facture
            </button>
          </div>

        </div>
      </form>
    </div>
  </div>
</main>
<!-- ğŸ“š Liste des factures PDF -->
<div class="card shadow-sm border-0 mt-5">
  <div class="card-header bg-dark text-white text-center fw-semibold">
    ğŸ“‚ Liste des Factures GÃ©nÃ©rÃ©es
  </div>
  <div class="card-body bg-white">
    <table class="table table-hover align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>NumÃ©ro</th>
          <th>Client</th>
          <th>Date dâ€™Ã©mission</th>
          <th>Montant total (â‚¬)</th>
          <th>TÃ©lÃ©charger PDF</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let f of invoices; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ f.number }}</td>
          <td>{{ f.clientName }}</td>
          <td>{{ f.issueDate | date:'dd/MM/yyyy' }}</td>
          <td>{{ f.total | number:'1.2-2' }}</td>
          <td>
            <button class="btn btn-outline-primary btn-sm" (click)="downloadPdf(f)">
              ğŸ“¥ TÃ©lÃ©charger
            </button>

          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="invoices.length === 0" class="text-center text-muted py-3">
      Aucune facture disponible.
    </div>
  </div>
</div>