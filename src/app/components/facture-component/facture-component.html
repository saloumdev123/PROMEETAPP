<main class="container py-5 bg-light min-vh-100">
  <h1 class="text-center mb-4 text-primary fw-bold display-5">
    üßæ Gestion des Factures Professionnelles
  </h1>

  <!-- üí° FORMULAIRE DE CR√âATION -->
  <div class="card shadow-lg mb-5 border-0">
    <div class="card-header bg-primary text-white text-center fs-5 fw-semibold">
      üß© Nouvelle Facture
    </div>
    <div class="card-body p-4 bg-white">
      <form [formGroup]="invoiceForm" (ngSubmit)="saveInvoice()">
        <div class="row g-3">

          <!-- üßë‚Äçü§ù‚Äçüßë S√©lection client -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">üë• S√©lectionner un client *</label>
            <select formControlName="clientId" class="form-select shadow-sm" (change)="onClientChange($event)">
              <option value="">-- Choisir un client --</option>
              <option *ngFor="let c of clients" [value]="c.id">{{ c.nom }} - {{ c.email }}</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">üè∑Ô∏è Titre de la facture *</label>
            <input type="text" formControlName="titre" class="form-control shadow-sm"
              placeholder="Ex : Facture de maintenance" />
          </div>

          <!-- üìã Description -->
          <div class="col-12">
            <label class="form-label fw-semibold text-secondary">üìù Description</label>
            <textarea formControlName="description" rows="2" class="form-control shadow-sm"
              placeholder="D√©tails de la prestation..."></textarea>
          </div>

          <!-- üìÖ Dates -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">üìÖ Date d‚Äô√©mission</label>
            <input type="date" formControlName="dateEmission" class="form-control shadow-sm" />
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-secondary">üìÜ Date d‚Äô√©ch√©ance</label>
            <input type="date" formControlName="dateEcheance" class="form-control shadow-sm" />
          </div>

          <!-- üßæ Num√©ro de facture + acompte -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="number" class="form-label fw-bold text-secondary">üî¢ Num√©ro de facture</label>
              <input type="text" id="number" formControlName="number" class="form-control shadow-sm"
                placeholder="EX: INV-2025-001">
            </div>

            <div class="col-md-6 mb-3">
              <label for="acompte" class="form-label fw-bold text-secondary">üí∂ Acompte (‚Ç¨)</label>
              <input type="number" id="acompte" formControlName="acompte" class="form-control shadow-sm"
                placeholder="0.00" step="0.01">
            </div>
          </div>

          <!-- üîñ R√©f√©rence / Devis / Paiement -->
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">üîñ R√©f√©rence</label>
            <input type="text" formControlName="reference" class="form-control shadow-sm" placeholder="REF-2025-001" />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">üìë Num√©ro de devis</label>
            <input type="text" formControlName="devisNumber" class="form-control shadow-sm" placeholder="DEV-0012" />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-secondary">üí≥ Mode de paiement</label>
            <select formControlName="paymentMode" class="form-select shadow-sm">
              <option value="Virement bancaire">Virement bancaire</option>
              <option value="Esp√®ces">Esp√®ces</option>
              <option value="Ch√®que">Ch√®que</option>
              <option value="Carte">Carte bancaire</option>
            </select>
          </div>

          <!-- üë§ INFOS CLIENT -->
          <div class="col-12">
            <h5 class="mt-4 text-primary fw-bold border-bottom pb-2">üë§ Informations Client</h5>
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="clientName" class="form-control shadow-sm"
              placeholder="Nom du client" />
          </div>
          <div class="col-md-6">
            <input type="email" formControlName="clientEmail" class="form-control shadow-sm"
              placeholder="Email du client" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="clientPhone" class="form-control shadow-sm" placeholder="T√©l√©phone" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="clientAddress" class="form-control shadow-sm"
              placeholder="Adresse compl√®te" />
          </div>

          <!-- üè¢ ENTREPRISE -->
          <div class="col-12">
            <h5 class="mt-4 text-primary fw-bold border-bottom pb-2">üè¢ Informations Soci√©t√©</h5>
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyName" class="form-control shadow-sm"
              placeholder="Nom de l'entreprise" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyContact" class="form-control shadow-sm"
              placeholder="Contact entreprise" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyPhone" class="form-control shadow-sm"
              placeholder="T√©l√©phone soci√©t√©" />
          </div>
          <div class="col-md-6">
            <input type="email" formControlName="companyEmail" class="form-control shadow-sm"
              placeholder="Email soci√©t√©" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companySiret" class="form-control shadow-sm" placeholder="SIRET" />
          </div>
          <div class="col-md-6">
            <input type="text" formControlName="companyTvaNumber" class="form-control shadow-sm"
              placeholder="Num√©ro TVA" />
          </div>
          <div class="col-md-12">
            <input type="text" formControlName="companyAddress" class="form-control shadow-sm"
              placeholder="Adresse compl√®te soci√©t√©" />
          </div>

          <!-- üßæ ARTICLES -->
          <div class="col-12 mt-4">
            <h5 class="text-primary fw-bold border-bottom pb-2">üßæ Articles de la facture</h5>

            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>R√©f√©rence</th>
                  <th>D√©signation</th>
                  <th>Quantit√©</th>
                  <th>P.U. HT (‚Ç¨)</th>
                  <th>Remise (%)</th>
                  <th>TVA (%)</th>
                  <th>Total HT (‚Ç¨)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody formArrayName="items">
                <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
                  <td><input type="text" formControlName="referenceCode" class="form-control"></td>
                  <textarea formControlName="label" class="form-control" rows="6"
                    style="white-space: pre-wrap; word-wrap: break-word;"
                    placeholder="Description d√©taill√©e de l‚Äôarticle (plusieurs lignes possibles)...">
                 </textarea>
                  <td><input type="number" formControlName="quantity" class="form-control" (input)="updateTotals()">
                  </td>
                  <td><input type="number" formControlName="unitPrice" class="form-control" (input)="updateTotals()">
                  </td>
                  <td><input type="number" formControlName="discountRate" class="form-control" (input)="updateTotals()">
                  </td>
                  <td><input type="number" formControlName="tvaRate" class="form-control" (input)="updateTotals()"></td>
                  <td class="fw-bold text-end">
                    {{ (item.value.quantity * item.value.unitPrice * (1 - item.value.discountRate / 100)) |
                    number:'1.2-2' }}
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeItem(i)">üóëÔ∏è</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="text-end">
              <button type="button" class="btn btn-outline-primary btn-sm" (click)="addItem()">‚ûï Ajouter un
                article</button>
            </div>
            <div class="mt-4 card shadow-sm p-3 bg-light">
              <div class="d-flex justify-content-end flex-column align-items-end">
                <p><strong>Base HT :</strong> {{ baseHT | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Remise :</strong> {{ invoiceForm.get('remise')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Montant TVA :</strong> {{ totalTVA | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>% TVA :</strong> {{ invoiceForm.get('pourcentTva')?.value }} %</p>
                <p><strong>Port :</strong> {{ invoiceForm.get('port')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Totaux :</strong> {{ invoiceForm.get('totaux')?.value | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Total TTC :</strong> {{ totalTTC | number:'1.2-2' }} ‚Ç¨</p>
                <p><strong>Net √† payer :</strong> {{ netAPayer | number:'1.2-2' }} ‚Ç¨</p>
              </div>
            </div>

          </div>


          <!-- ‚úÖ Enregistrer -->
          <div class="col-12 text-end mt-4">
            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold shadow-sm"
              [disabled]="invoiceForm.invalid || loading">
              üíæ Enregistrer la facture
            </button>
          </div>

        </div>
      </form>
    </div>
  </div>
</main>
<!-- üìö Liste des factures PDF -->
<div class="card shadow-sm border-0 mt-5">
  <div class="card-header bg-dark text-white text-center fw-semibold">
    üìÇ Liste des Factures G√©n√©r√©es
  </div>
  <div class="card-body bg-white">
    <table class="table table-hover align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Num√©ro</th>
          <th>Client</th>
          <th>Date d‚Äô√©mission</th>
          <th>Montant total (‚Ç¨)</th>
          <th>T√©l√©charger PDF</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let f of invoices; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ f.number }}</td>
          <td>{{ f.clientName }}</td>
          <td>{{ f.issueDate | date:'dd/MM/yyyy' }}</td>
          <td>{{ f.total | number:'1.2-2' }}</td>
          <td>
            <button class="btn btn-outline-primary btn-sm" (click)="downloadPdf(f)">
              üì• T√©l√©charger
            </button>

          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="invoices.length === 0" class="text-center text-muted py-3">
      Aucune facture disponible.
    </div>
  </div>
</div>