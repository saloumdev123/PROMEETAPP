<section class="container my-4" [formGroup]="devisForm">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <img [src]="devisForm.get('entreprise')!.value.logoUrl || logoPath" alt="logo" style="height:60px; object-fit:contain" />
      <div class="ms-2 d-inline-block align-top" style="margin-left:8px">
        <h4 class="mb-0">{{ devisForm.get('entreprise')!.value.nom }}</h4>
        <small class="text-muted">{{ devisForm.get('entreprise')!.value.responsable }}</small>
      </div>
    </div>

    <div class="text-end">
      <div style="border:1px solid #333; padding:6px; display:inline-block; min-width:200px; text-align:center; background:#f2f7ff">
        <div style="font-weight:700">Devis en EURO</div>
        <div>N° <strong>{{ devisForm.get('numero')!.value }}</strong></div>
      </div>
      <div class="mt-2">
        <small>Date : </small>
        <input type="date" class="form-control d-inline-block" style="width:150px; margin-left:6px"
               formControlName="date" />
      </div>
    </div>
  </div>

  <!-- ENTREPRISE / CLIENT SIDE -->
  <div class="row mb-3">
    <div class="col-md-7">
      <div class="card p-3">
        <h6 class="mb-2">Informations entreprise</h6>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Nom</label>
            <input class="form-control" [value]="devisForm.get('entreprise')!.value.nom" readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label">Responsable</label>
            <input class="form-control" [value]="devisForm.get('entreprise')!.value.responsable" readonly />
          </div>
          <div class="col-12">
            <label class="form-label">Adresse</label>
            <input class="form-control" [value]="devisForm.get('entreprise')!.value.adresse" readonly />
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <div class="card p-3">
        <h6 class="mb-2">Client</h6>

        <label class="form-label">Sélectionner un client</label>
        <select class="form-select mb-2" (change)="onClientChange($event)">
          <option value="">-- Choisir --</option>
          <option *ngFor="let c of clients" [value]="c.id">{{ c.nom }}</option>
        </select>

        <!-- inputs client (editable) - patch directement le form group -->
        <div class="mb-2" [formGroup]="clientGroup">
          <input class="form-control mb-1" placeholder="Nom" formControlName="nom" />
          <input class="form-control mb-1" placeholder="Gérant" formControlName="gerant" />
          <input class="form-control mb-1" placeholder="Adresse" formControlName="adresse" />
          <input class="form-control mb-1" placeholder="Code postal / Ville" formControlName="codePostalVille" />
          <input class="form-control mb-1" placeholder="Téléphone" formControlName="telephone" />
          <input class="form-control" placeholder="Email" type="email" formControlName="email" />
        </div>
      </div>
    </div>
  </div>

  <!-- DESCRIPTION -->
  <div class="mb-3">
    <label class="form-label">Description du poste</label>
    <textarea class="form-control" formControlName="descriptionPoste" rows="2"></textarea>
  </div>

  <!-- LIGNES -->
 <div formArrayName="lignes" class="card p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0">Lignes</h6>
    <div>
      <button type="button" class="btn btn-sm btn-outline-primary me-2" (click)="addLigne()">+ Ligne</button>
      <button type="button" class="btn btn-sm btn-outline-success" (click)="updateTotals()">Recalculer</button>
    </div>
  </div>

  <div *ngIf="lignes.length === 0" class="text-muted">Aucune ligne</div>

  <div *ngFor="let l of lignes.controls; let i = index" [formGroupName]="i" class="mb-2 border rounded p-2">
    <div class="row g-2 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Désignation</label>
        <input class="form-control" formControlName="designation" />
      </div>
      <div class="col-md-1">
        <label class="form-label">U</label>
        <input class="form-control" formControlName="unite" />
      </div>
      <div class="col-md-1">
        <label class="form-label">Qté</label>
        <input type="number" class="form-control text-center" formControlName="quantite" (input)="onLineInputChange(i)" />
      </div>
      <div class="col-md-2">
        <label class="form-label">PU HT</label>
        <input type="number" class="form-control text-end" formControlName="prixUnitaireHt" (input)="onLineInputChange(i)" />
      </div>
      <div class="col-md-1">
        <label class="form-label">Montant</label>
        <input class="form-control" formControlName="montantHt" readonly />
      </div>
      <div class="col-md-1 text-end">
        <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeLigne(i)">✖</button>
      </div>
    </div>
  </div>
</div>

  <!-- RECAPITULATIF / TVA / ACTIONS -->
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Conditions de règlement</label>
      <textarea class="form-control" rows="3" formControlName="conditionsPaiement"></textarea>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <div class="row g-2">
          <div class="col-md-6">
            <label>Total HT</label>
            <input class="form-control" [value]="devisForm.get('totalHt')!.value | number:'1.2-2'" readonly />
          </div>
          <div class="col-md-3">
            <label>TVA (%)</label>
            <input type="number" class="form-control" formControlName="tvaPourcentage" />
          </div>
          <div class="col-md-3">
            <label>Montant TVA</label>
            <input class="form-control" [value]="devisForm.get('tva')!.value | number:'1.2-2'" readonly />
          </div>

          <div class="col-12 text-end mt-2">
            <h5>Total TTC : {{ devisForm.get('totalTtc')!.value | number:'1.2-2' }} €</h5>
          </div>

          <div class="col-12 text-end mt-3">
            <button class="btn btn-success me-2" (click)="saveDevis()" [disabled]="isSaving">
              {{ isSaving ? 'Enregistrement...' : 'Enregistrer' }}
            </button>
            <button class="btn btn-outline-primary me-2" (click)="previewPdf()">Aperçu PDF</button>
            <button class="btn btn-primary" (click)="downloadPdf()">Télécharger PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
