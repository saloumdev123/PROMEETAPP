<section class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Cr√©er / √âditer un devis</h2>
    <img src="assets/images/logofibem.png" alt="Logo" style="height: 60px; object-fit: contain;" />
  </div>
  <!-- ‚úÖ Le formGroup doit √™tre sur la balise <form> -->
  <form [formGroup]="devisForm" (ngSubmit)="save()">
    <!-- Informations g√©n√©rales -->
    <div class="card p-3 mb-4 shadow-sm">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Num√©ro</label>
          <input formControlName="numero" class="form-control" placeholder="Ex: DEV-001" />
          <div class="text-danger small" *ngIf="devisForm.get('numero')?.invalid && devisForm.get('numero')?.touched">
            Num√©ro requis.
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Date</label>
          <input formControlName="date" type="date" class="form-control" />
          <div class="text-danger small" *ngIf="devisForm.get('date')?.invalid && devisForm.get('date')?.touched">
            Date requise.
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Client</label>
          <input formControlName="clientNom" class="form-control" placeholder="Nom du client" />
          <div class="text-danger small" *ngIf="devisForm.get('clientNom')?.invalid && devisForm.get('clientNom')?.touched">
            Nom du client requis.
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Adresse</label>
          <input formControlName="clientAdresse" class="form-control" placeholder="Adresse" />
        </div>

        <div class="col-md-4">
          <label class="form-label">Ville</label>
          <input formControlName="clientVille" class="form-control" placeholder="Ville" />
        </div>

        <div class="col-md-4">
          <label class="form-label">T√©l√©phone</label>
          <input formControlName="clientTel" class="form-control" placeholder="T√©l√©phone" />
        </div>

        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea formControlName="description" rows="2" class="form-control" placeholder="Objet du devis / remarques"></textarea>
        </div>
      </div>
    </div>

    <!-- ‚úÖ Lignes du devis -->
    <div class="card p-3 mb-4 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Lignes du devis</h5>
        <button type="button" class="btn btn-sm btn-primary" (click)="addLigne()">+ Ajouter une ligne</button>
      </div>

      <div *ngIf="lignes.length === 0" class="text-muted mb-2">Aucune ligne ajout√©e.</div>

      <!-- ‚úÖ FormArray pour les lignes -->
      <div formArrayName="lignes">
        <div *ngFor="let ligne of lignes.controls; let i = index" [formGroupName]="i" class="mb-3 border rounded p-2">
          <div class="row g-2 align-items-end">
            <div class="col-md-5">
              <label class="form-label">D√©signation</label>
              <input formControlName="designation" class="form-control" placeholder="D√©signation" />
              <div class="text-danger small" *ngIf="ligne.get('designation')?.invalid && ligne.get('designation')?.touched">
                D√©signation requise.
              </div>
            </div>

            <div class="col-md-2">
              <label class="form-label">Quantit√©</label>
              <input formControlName="quantite" type="number" min="1" class="form-control"
                (input)="ligne.get('montantTotal')?.setValue( (ligne.get('quantite')?.value || 0) * (ligne.get('prixUnitaire')?.value || 0) )" />
            </div>

            <div class="col-md-2">
              <label class="form-label">Prix unitaire</label>
              <input formControlName="prixUnitaire" type="number" min="0" class="form-control"
                (input)="ligne.get('montantTotal')?.setValue( (ligne.get('quantite')?.value || 0) * (ligne.get('prixUnitaire')?.value || 0) )" />
            </div>

            <div class="col-md-2">
              <label class="form-label">Montant</label>
              <input formControlName="montantTotal" readonly class="form-control" />
            </div>

            <div class="col-md-1 text-end">
              <button type="button" class="btn btn-outline-danger btn-sm" (click)="lignes.removeAt(i)">‚úñ</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ Fournitures -->
    <div class="card p-3 mb-4 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Fournitures</h5>
        <button type="button" class="btn btn-sm btn-secondary" (click)="addFourniture()">+ Ajouter une fourniture</button>
      </div>

      <div *ngIf="fournituresArray.length === 0" class="text-muted mb-2">Aucune fourniture ajout√©e.</div>

      <!-- ‚úÖ FormArray pour les fournitures -->
      <div formArrayName="fournitures">
        <div *ngFor="let f of fournituresArray.controls; let j = index" [formGroupName]="j" class="mb-3 border rounded p-2">
          <div class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label">D√©signation</label>
              <input formControlName="designation" class="form-control" placeholder="D√©signation" />
            </div>

            <div class="col-md-2">
              <label class="form-label">Unit√©</label>
              <input formControlName="unite" class="form-control" placeholder="ex: m, unit√©" />
            </div>

            <div class="col-md-2">
              <label class="form-label">Quantit√©</label>
              <input formControlName="quantite" type="number" min="0.1" step="0.1" class="form-control"
                (input)="f.get('montantTotal')?.setValue( (f.get('quantite')?.value || 0) * (f.get('prixUnitaire')?.value || 0) )" />
            </div>

            <div class="col-md-2">
              <label class="form-label">Prix unitaire</label>
              <input formControlName="prixUnitaire" type="number" min="0" class="form-control"
                (input)="f.get('montantTotal')?.setValue( (f.get('quantite')?.value || 0) * (f.get('prixUnitaire')?.value || 0) )" />
            </div>

            <div class="col-md-1">
              <label class="form-label">Type</label>
              <select formControlName="type" class="form-select">
                <option *ngFor="let t of typeOptions" [value]="t">{{ t }}</option>
              </select>
            </div>

            <div class="col-md-1 text-end">
              <button type="button" class="btn btn-outline-danger btn-sm" (click)="fournituresArray.removeAt(j)">‚úñ</button>
            </div>
          </div>

          <div class="mt-2">
            <small>Montant fourniture : <strong>{{ f.get('montantTotal')?.value || 0 | number:'1.2-2' }}</strong></small>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ R√©capitulatif -->
<!-- ‚úÖ R√©capitulatif -->
<div class="card p-3 mb-4 shadow-sm">
  <div class="row g-3 align-items-center">
    <div class="col-md-3">
      <label class="form-label">Total HT (‚Ç¨)</label>
      <input formControlName="totalHT" readonly class="form-control" />
    </div>

    <div class="col-md-2">
      <label class="form-label">TVA (%)</label>
      <input formControlName="tva" type="number" min="0" class="form-control" />
      <!-- üí∞ Montant TVA dynamique -->
      <div class="mt-1 text-muted small">
        TVA : <strong>{{ montantTVA | number:'1.2-2' }} ‚Ç¨</strong>
      </div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Total TTC (‚Ç¨)</label>
      <input formControlName="totalTTC" readonly class="form-control" />
    </div>

    <div class="col-md-4 text-end">
      <button type="submit" [disabled]="devisForm.invalid" class="btn btn-success mt-2">
        üíæ Enregistrer le devis
      </button>
      <button
        type="button"
        class="btn btn-outline-secondary mt-2 ms-2"
        (click)="devisForm.reset(); lignes.clear(); fournituresArray.clear(); montantTVA = 0;"
      >
        üîÑ R√©initialiser
      </button>
    </div>
  </div>
</div>

  </form>

  <!-- ‚úÖ Liste des devis existants -->
  <div class="card p-3 shadow-sm">
    <h5>Devis existants</h5>
    <div *ngIf="devisList.length === 0" class="text-muted">Aucun devis trouv√©.</div>

    <div *ngFor="let d of devisList" class="border-bottom py-2 d-flex justify-content-between align-items-center">
      <div>
        <strong>#{{ d.numero }}</strong> ‚Äî {{ d.clientNom }} <small class="text-muted">({{ d.date }})</small>
        <div class="small">Total TTC: {{ d.totalTTC || d.total || 0 | number:'1.2-2' }}</div>
      </div>

      <div>
        <button class="btn btn-sm btn-outline-primary me-2">Voir</button>
        <button class="btn btn-sm btn-danger" (click)="deleteDevis(d.id)">Supprimer</button>
      </div>
    </div>
  </div>
</section>
