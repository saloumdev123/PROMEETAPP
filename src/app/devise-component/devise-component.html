<div class="devis-form-container">
  <h2>Cr√©ation de Devis</h2>

  <form [formGroup]="devisForm" (ngSubmit)="onSubmit()">
    <!-- === INFOS DEVIS === -->
    <div class="form-group">
      <label>Num√©ro du Devis</label>
      <input type="text" formControlName="number" placeholder="Ex: DE 0031" />
    </div>

    <div class="form-group">
      <label>Nom du Client</label>
      <input type="text" formControlName="clientName" placeholder="Ex: St√© OCARO RENO" />
    </div>

    <div class="form-group">
      <label>Date d'√âmission</label>
      <input type="date" formControlName="dateEmission" />
    </div>

    <!-- === SECTION : D√âTAILS DU POSTE √Ä POURVOIR === -->
    <h3 class="section-title">D√©tails : Poste √† Pourvoir</h3>

    <div class="form-group">
      <label>Titre du Poste</label>
      <input type="text" formControlName="posteTitle" placeholder="Ex : Ma√ßon - Carreleur confirm√©" />
    </div>

    <div class="form-group">
      <label>Description du Poste</label>
      <textarea formControlName="descriptionPoste" rows="5"
        placeholder="Ex : Description du poste, missions, lieu, etc."></textarea>
    </div>

    <div class="form-group">
      <label>Assistance Technique</label>
      <textarea formControlName="assistanceTechnique" rows="5"
        placeholder="Ex : D√©tails techniques, mat√©riel requis, etc."></textarea>
    </div>

    <div class="form-group">
      <label>Profil Recherch√©</label>
      <textarea formControlName="profil" rows="5"
        placeholder="Ex : Autonomie, rigueur, exp√©rience 3‚Äì5 ans, etc."></textarea>
    </div>
    <div class="signature-section">
      <h4>Conditions de r√®glement :</h4>
      <div class="signature-inputs">
        <div>
          <label>Signature client :</label>
          <input type="file" accept="image/*" (change)="onClientSignatureSelected($event)">
        </div>
        <div>
          <label>Signature entreprise :</label>
          <input type="file" accept="image/*" (change)="onCompanySignatureSelected($event)">
        </div>
      </div>

      <div class="preview-signatures">
        <img *ngIf="clientSignature" [src]="clientSignature" alt="Signature client">
        <img *ngIf="companySignature" [src]="companySignature" alt="Signature entreprise">
      </div>
    </div>
    <!-- === TABLEAU R√âCAPITULATIF === -->
    <h3 class="section-title">R√âCAPITULATIF Total Travaux OUVRAGES Phase 1</h3>

    <table class="recap-table">
      <thead>
        <tr>
          <th>Total Heures</th>
          <th>R√âCAPITULATIF Travaux / Ouvrages</th>
          <th>Total H.T.</th>
          <th></th>
        </tr>
      </thead>

      <tbody formArrayName="travaux">
        <tr *ngFor="let ligne of travaux.controls; let i = index" [formGroupName]="i">
          <td class="heures">0,00h</td>
          <td><input formControlName="description" placeholder="Description du poste" /></td>
          <td><input type="number" formControlName="montant" /></td>
          <td><button type="button" (click)="removeLigne(i)">üóëÔ∏è</button></td>
        </tr>
      </tbody>
    </table>

    <button type="button" (click)="addLigne()">+ Ajouter une ligne</button>

    <div class="total">
      <strong>TOTAL ‚Ç¨ HT Travaux OUVRAGES Phase 1 :</strong>
      <span>{{ totalHT | number:'1.2-2' }} ‚Ç¨</span>
    </div>
    <h3 class="section-title">Tableau Travaux / Ouvrages</h3>

    <table class="table-ouvrages" formArrayName="lignesOuvrages">
      <thead>
        <tr>
          <th>Temps M.O.</th>
          <th>D√©signations d‚ÄôOuvrages</th>
          <th>U</th>
          <th>Prix unit. HT</th>
          <th>Qt√©</th>
          <th>Montant Total H.T.</th>
          <th>Tps Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ligne of lignesOuvrages().controls; let i = index" [formGroupName]="i">
          <td><input type="text" formControlName="tempsMO" placeholder="Ex: 2,00h"></td>
          <td><textarea formControlName="designation" placeholder="D√©tails du travail..."></textarea></td>
          <td><input type="text" formControlName="unite" placeholder="u / Ens"></td>
          <td><input type="number" formControlName="prixUnitaireHT" (input)="updateMontant(i)"></td>
          <td><input type="number" formControlName="quantite" (input)="updateMontant(i)"></td>
          <td>{{ ligne.get('montantTotalHT')?.value | number:'1.2-2' }} ‚Ç¨</td>
          <td><input type="text" formControlName="tpsTotal" placeholder="Ex: 3,00h"></td>
          <td><button type="button" (click)="removeLigneOuvrage(i)">üóëÔ∏è</button></td>
        </tr>
      </tbody>
    </table>

    <button type="button" (click)="addLigneOuvrage()">+ Ajouter une ligne</button>

    <div class="total">
      <strong>Total Travaux OUVRAGES Phase 1 :</strong>
      <span>{{ totalHT | number:'1.2-2' }} ‚Ç¨</span>
    </div>

    <div class="actions">
      <button type="button" (click)="generatePdf()">üìÑ G√©n√©rer le PDF</button>
      <button type="submit" [disabled]="!devisForm.valid">üíæ Enregistrer & T√©l√©charger PDF</button>
    </div>
  </form>
</div>

<!-- === üßæ TABLEAU DES DEVIS ENREGISTR√âS === -->
<h3 class="section-title" style="margin-top: 40px;">üìÇ Devis Enregistr√©s</h3>

<table class="saved-devis-table" *ngIf="listeDevis && listeDevis.length > 0; else aucunDevis">
  <thead>
    <tr>
      <th>#</th>
      <th>Num√©ro</th>
      <th>Client</th>
      <th>Date</th>
      <th>Total HT</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let d of listeDevis; let i = index">
      <td>{{ i + 1 }}</td>
      <td>{{ d.number }}</td>
      <td>{{ d.clientName }}</td>
      <td>{{ d.dateEmission | date }}</td>
      <td>{{ d.totalHt || '‚Äî' }}</td>
      <td>
        <button (click)="telechargerPdf(d)">‚¨áÔ∏è T√©l√©charger PDF</button>
      </td>
    </tr>
  </tbody>
</table>


<ng-template #aucunDevis>
  <p>Aucun devis enregistr√© pour le moment.</p>
</ng-template>